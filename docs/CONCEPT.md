Концепция парсера
=================

Задача перед новой версией парсера - отслеживание изменений в данных расписания.
Для достижения цели необходимо изменить подход к сбору и хранению данных.

## Как сейчас

1. Берется файл со всеми группами `/groups-list.json`.
2. По каждой группе отправляется запрос на получение расписания группы `/site/group`.
3. Если получена ошибка, то парсер просто переходит к следующей.
4. Если получено расписание, то из него берутся пары и сохраняются во временный общий массив.
5. После прохода по всем группам парсер возвращает большой массив со всеми ответами без ошибок.
6. Массив передается в контроллер БД.
7. БД частично обнуляется, а именно таблица с привязкой преподавателей к парам и пар к группам.
8. Начинается длительный процесс обновления связей между парами, группами и преподавателями. 
Сначала проверяется пара на существование, затем вносится, если не найдено совпадений, или берется ИД пары.
Аналогично с преподавателями и группами. Затем по полученным данным собираются таблицы связей между ними.

    #### Минусы

- обновление данных в БД происходит очень долго, так как все данные обрабатываются одновременно,
а это ~30 тысяч уникальных пар, 1000 преподавателей и 10 тысяч пар по группам и преподавателям; 
- для установки связей требуется примерно 120 тысяч операций, а это очень много для 1 транзакции;
- невозможно отследить изменения в расписании;
- хранение устаревших пар/преподавателей/аудиторий, так как они не обновляются, а добавляются.

## Новая концепция

1. Берется файл со всеми группами `/groups-list.json`.
2. Вносится в БД, проверяя разницу со списком в БД.
    - Если в базе есть группа, а в полученном списке её нет - удаляются всё связанные пары.
    - Если в базе нет группы - вносится в базу с отметкой, когда была внесена.
3. Далее берется 1 группа и удаляются пары, помеченные на удаление и удаляем пометки "новая".
4. Получаем её расписание с сайта.
5. Начинаем сравнивать полученное расписание и имеющееся в БД.
    - Если в базе пара совпадает с полученной - помечаем дату последней проверки.
    - Если в базе пара отсутствует - добавляем с пометкой "новая".
6. Помечаем все не обработанные пары "на удаление", сравнивая поле последней проверки или поля с датой последней проверки.
7. Помечаем дату обновления расписания группы.
8. Закрываем транзакцию.
9. Повторяем с 3 пункта до конца списка групп.

#### По итогу получаем

Всё ещё очень много операций с БД, но это не так критично, так как данные вносятся
постепенно и в случае ошибки сбора данных в одной из групп расписание остальных будет обновлено.
Ещё можно закрепить пары за днем недели и номером пары, помечая обновление в них.
